import { createClient } from '@supabase/supabase-js'
import dotenv from 'dotenv'

// Charger les variables d'environnement
dotenv.config()

const supabaseUrl = process.env.VITE_SUPABASE_URL
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrb3JkbnlpdGd2cnRpb3V3ZGF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzcxODc2MCwiZXhwIjoyMDY5Mjk0NzYwfQ.Yn3Bye8lMlqAuRsh0entx73CnRnT3a3aTYYYZdzxsfU'

if (!supabaseUrl) {
  console.error('‚ùå VITE_SUPABASE_URL manquant dans .env')
  process.exit(1)
}

// Cr√©er le client Supabase avec la cl√© de service
const supabase = createClient(supabaseUrl, supabaseServiceKey)

// Donn√©es des communes de Kinshasa
const COMMUNES_DATA = [
  { name: "Bandalungwa", population: 120000, coordinates: "-4.4419,15.2663" },
  { name: "Barumbu", population: 95000, coordinates: "-4.4419,15.2663" },
  { name: "Bumbu", population: 180000, coordinates: "-4.4419,15.2663" },
  { name: "Gombe", population: 250000, coordinates: "-4.4419,15.2663" },
  { name: "Kalamu", population: 200000, coordinates: "-4.4419,15.2663" },
  { name: "Kasa-Vubu", population: 150000, coordinates: "-4.4419,15.2663" },
  { name: "Kimbanseke", population: 300000, coordinates: "-4.4419,15.2663" },
  { name: "Kinshasa", population: 220000, coordinates: "-4.4419,15.2663" },
  { name: "Kintambo", population: 110000, coordinates: "-4.4419,15.2663" },
  { name: "Kisenso", population: 160000, coordinates: "-4.4419,15.2663" },
  { name: "Lemba", population: 140000, coordinates: "-4.4419,15.2663" },
  { name: "Limete", population: 170000, coordinates: "-4.4419,15.2663" },
  { name: "Lingwala", population: 130000, coordinates: "-4.4419,15.2663" },
  { name: "Makala", population: 190000, coordinates: "-4.4419,15.2663" },
  { name: "Maluku", population: 80000, coordinates: "-4.4419,15.2663" },
  { name: "Masina", population: 280000, coordinates: "-4.4419,15.2663" },
  { name: "Matete", population: 210000, coordinates: "-4.4419,15.2663" },
  { name: "Mont-Ngafula", population: 90000, coordinates: "-4.4419,15.2663" },
  { name: "Ndjili", population: 240000, coordinates: "-4.4419,15.2663" },
  { name: "Ngaba", population: 120000, coordinates: "-4.4419,15.2663" },
  { name: "Ngaliema", population: 260000, coordinates: "-4.4419,15.2663" },
  { name: "Ngiri-Ngiri", population: 100000, coordinates: "-4.4419,15.2663" },
  { name: "N'sele", population: 70000, coordinates: "-4.4419,15.2663" },
  { name: "Selembao", population: 85000, coordinates: "-4.4419,15.2663" }
]

// Types de probl√®mes r√©els
const PROBLEM_TYPES_DATA = [
  { name: "Ordures m√©nag√®res", description: "Accumulation d'ordures, poubelles pleines, d√©charges sauvages", priority_level: 3 },
  { name: "√âclairage public", description: "Lampadaires d√©fectueux, zones sombres, pannes d'√©clairage", priority_level: 2 },
  { name: "Voirie d√©grad√©e", description: "Nids-de-poule, routes endommag√©es, trottoirs cass√©s", priority_level: 3 },
  { name: "Inondations", description: "Eaux stagnantes, d√©bordements, drainage d√©faillant", priority_level: 3 },
  { name: "Approvisionnement en eau", description: "Coupures d'eau, fuites, pression insuffisante", priority_level: 3 },
  { name: "Pannes √©lectriques", description: "Coupures de courant, transformateurs d√©fectueux", priority_level: 2 },
  { name: "Ins√©curit√©", description: "Vols, agressions, zones dangereuses", priority_level: 3 },
  { name: "Infrastructures publiques", description: "√âcoles, h√¥pitaux, b√¢timents publics d√©grad√©s", priority_level: 2 },
  { name: "Espaces verts", description: "Parks n√©glig√©s, arbres malades, espaces publics", priority_level: 1 },
  { name: "Services publics", description: "Transports, postes, services administratifs", priority_level: 2 },
  { name: "Transport", description: "Probl√®mes de transport public, routes bloqu√©es", priority_level: 2 },
  { name: "Autre", description: "Autres probl√®mes non cat√©goris√©s", priority_level: 1 }
]

// Donn√©es de test pour les signalements
const SAMPLE_REPORTS = [
  {
    problem_type_name: "Ordures m√©nag√®res",
    commune_name: "Gombe",
    description: "Accumulation d'ordures importantes √† l'intersection Avenue Kasa-Vubu et Boulevard du 30 Juin",
    address: "Avenue Kasa-Vubu, Gombe",
    priority: "high",
    status: "pending",
    is_anonymous: true
  },
  {
    problem_type_name: "√âclairage public",
    commune_name: "Kalamu",
    description: "Lampadaires √©teints depuis 3 jours sur la Route de Matadi",
    address: "Route de Matadi, Kalamu",
    priority: "medium",
    status: "in-progress",
    is_anonymous: false
  },
  {
    problem_type_name: "Voirie d√©grad√©e",
    commune_name: "Ngaliema",
    description: "Nids-de-poule dangereux sur l'Avenue de la Justice",
    address: "Avenue de la Justice, Ngaliema",
    priority: "high",
    status: "resolved",
    is_anonymous: true
  },
  {
    problem_type_name: "Inondations",
    commune_name: "Masina",
    description: "Eaux stagnantes apr√®s la pluie dans le quartier Masina 1",
    address: "Quartier Masina 1, Masina",
    priority: "high",
    status: "pending",
    is_anonymous: false
  },
  {
    problem_type_name: "Approvisionnement en eau",
    commune_name: "Limete",
    description: "Coupure d'eau depuis 2 jours dans le quartier Limete 1",
    address: "Quartier Limete 1, Limete",
    priority: "high",
    status: "in-progress",
    is_anonymous: true
  }
]

async function testConnection() {
  console.log('üîç Test de connexion √† Supabase...')
  
  try {
    const { data, error } = await supabase.from('communes').select('count').limit(1)
    
    if (error) {
      console.log('‚ö†Ô∏è  Tables pas encore cr√©√©es, c\'est normal pour la premi√®re fois')
      return false
    }
    
    console.log('‚úÖ Connexion r√©ussie !')
    return true
  } catch (error) {
    console.error('‚ùå Erreur de connexion:', error.message)
    return false
  }
}

async function initializeCommunes() {
  console.log('üèòÔ∏è  Initialisation des communes...')
  
  try {
    // V√©rifier si les communes existent d√©j√†
    const { data: existingCommunes } = await supabase
      .from('communes')
      .select('name')

    if (existingCommunes && existingCommunes.length > 0) {
      console.log('‚úÖ Communes d√©j√† initialis√©es')
      return existingCommunes
    }

    // Ins√©rer les communes
    const { data, error } = await supabase
      .from('communes')
      .insert(COMMUNES_DATA)
      .select()

    if (error) {
      console.error('‚ùå Erreur lors de l\'insertion des communes:', error)
      return []
    }

    console.log(`‚úÖ ${COMMUNES_DATA.length} communes ins√©r√©es avec succ√®s`)
    return data
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'initialisation des communes:', error)
    return []
  }
}

async function initializeProblemTypes() {
  console.log('üö® Initialisation des types de probl√®mes...')
  
  try {
    // V√©rifier si les types existent d√©j√†
    const { data: existingTypes } = await supabase
      .from('problem_types')
      .select('name')

    if (existingTypes && existingTypes.length > 0) {
      console.log('‚úÖ Types de probl√®mes d√©j√† initialis√©s')
      return existingTypes
    }

    // Ins√©rer les types de probl√®mes
    const { data, error } = await supabase
      .from('problem_types')
      .insert(PROBLEM_TYPES_DATA)
      .select()

    if (error) {
      console.error('‚ùå Erreur lors de l\'insertion des types de probl√®mes:', error)
      return []
    }

    console.log(`‚úÖ ${PROBLEM_TYPES_DATA.length} types de probl√®mes ins√©r√©s avec succ√®s`)
    return data
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'initialisation des types de probl√®mes:', error)
    return []
  }
}

async function createSampleReports(communes, problemTypes) {
  console.log('üìù Cr√©ation de signalements de test...')
  
  try {
    const reports = []
    
    for (const sampleReport of SAMPLE_REPORTS) {
      // Trouver la commune et le type de probl√®me
      const commune = communes.find(c => c.name === sampleReport.commune_name)
      const problemType = problemTypes.find(pt => pt.name === sampleReport.problem_type_name)
      
      if (commune && problemType) {
        reports.push({
          problem_type_id: problemType.id,
          commune_id: commune.id,
          description: sampleReport.description,
          address: sampleReport.address,
          priority: sampleReport.priority,
          status: sampleReport.status,
          is_anonymous: sampleReport.is_anonymous
        })
      }
    }
    
    if (reports.length > 0) {
      const { data, error } = await supabase
        .from('reports')
        .insert(reports)
        .select()

      if (error) {
        console.error('‚ùå Erreur lors de l\'insertion des signalements:', error)
        return
      }

      console.log(`‚úÖ ${reports.length} signalements de test cr√©√©s avec succ√®s`)
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de la cr√©ation des signalements de test:', error)
  }
}

async function createTestUsers() {
  console.log('üë• Cr√©ation des utilisateurs de test...')
  
  try {
    // V√©rifier si les utilisateurs de test existent d√©j√†
    const { data: existingUsers } = await supabase
      .from('users')
      .select('email')
      .in('email', ['admin@kinshasa-alerte.rdc', 'bourgmestre.gombe@kinshasa-alerte.rdc'])

    if (existingUsers && existingUsers.length > 0) {
      console.log('‚úÖ Utilisateurs de test d√©j√† cr√©√©s')
      return
    }

    // R√©cup√©rer l'ID de la commune de Gombe
    const { data: gombeCommune } = await supabase
      .from('communes')
      .select('id')
      .eq('name', 'Gombe')
      .single()

    // Cr√©er les utilisateurs de test
    const testUsers = [
      {
        email: 'admin@kinshasa-alerte.rdc',
        full_name: 'Administrateur Principal',
        role: 'admin'
      },
      {
        email: 'bourgmestre.gombe@kinshasa-alerte.rdc',
        full_name: 'Bourgmestre de Gombe',
        role: 'bourgmestre',
        commune_id: gombeCommune?.id
      }
    ]

    const { data, error } = await supabase
      .from('users')
      .insert(testUsers)

    if (error) {
      console.error('‚ùå Erreur lors de la cr√©ation des utilisateurs de test:', error)
      return
    }

    console.log('‚úÖ Utilisateurs de test cr√©√©s avec succ√®s')
    console.log('üìß Emails de test:')
    console.log('   - admin@kinshasa-alerte.rdc (Admin)')
    console.log('   - bourgmestre.gombe@kinshasa-alerte.rdc (Bourgmestre)')
  } catch (error) {
    console.error('‚ùå Erreur lors de la cr√©ation des utilisateurs de test:', error)
  }
}

async function main() {
  console.log('üöÄ Initialisation compl√®te de la base de donn√©es Kinshasa-Alerte')
  console.log('=' .repeat(60))
  
  // Test de connexion
  const isConnected = await testConnection()
  
  if (!isConnected) {
    console.log('\nüìã Veuillez d\'abord ex√©cuter le script SQL dans Supabase:')
    console.log('1. Allez dans votre dashboard Supabase')
    console.log('2. Ouvrez l\'√©diteur SQL')
    console.log('3. Copiez et ex√©cutez le contenu de database-schema.sql')
    console.log('4. Relancez ce script')
    return
  }
  
  // Initialiser les donn√©es
  const communes = await initializeCommunes()
  const problemTypes = await initializeProblemTypes()
  
  // Cr√©er des signalements de test
  if (communes.length > 0 && problemTypes.length > 0) {
    await createSampleReports(communes, problemTypes)
  }
  
  // Cr√©er les utilisateurs de test
  await createTestUsers()
  
  console.log('\nüéâ Initialisation termin√©e !')
  console.log('\nüìä Donn√©es cr√©√©es:')
  console.log(`   - ${communes.length} communes`)
  console.log(`   - ${problemTypes.length} types de probl√®mes`)
  console.log(`   - ${SAMPLE_REPORTS.length} signalements de test`)
  console.log('   - 2 utilisateurs de test')
  
  console.log('\nüìã Prochaines √©tapes:')
  console.log('1. Lancez l\'application: npm run dev')
  console.log('2. Testez l\'authentification avec les comptes de test')
  console.log('3. V√©rifiez que les donn√©es sont bien charg√©es')
  console.log('4. Testez le formulaire de signalement')
}

main().catch(console.error) 